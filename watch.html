<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>watch - Pikko Videos</title>
  <meta name="description" content="Let's watch the videos and musics.">
  <meta property="og:title" content="Pikko Videos">
  <meta property="og:description" content="Let's watch the videos.">
  <meta property="og:url" content="https://videos.bird.f5.si">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script>const SERVER = "https://pikko1.tcpexposer.com";</script>
  <script src="https://unpkg.com/wavesurfer.js"></script>
  <script src="js/dark.js"></script>
  <link rel="stylesheet" href="css/animation.css">
  <link rel="stylesheet" href="css/dark.css">
  <style>
    body {
      font-family: sans-serif;
    }
    .error {
      color: red;
      font-weight: bold;
      margin-top: 1em;
    }
    #waveform {
      width: 100%;
      height: 100px;
      background: #f0f0f0;
      margin-top: 20px;
    }
    #controls {
      margin-top: 10px;
    }
    button {
      background: #0af;
      color: white;
      border: none;
      padding: 8px 14px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover {
      background: #09c;
    }
    .lockIcon {
      width: 16px;
      height: 16px;
      vertical-align: middle;
      margin-left: 4px;
    }
    .author {
      display: flex;
      align-items: center;
      margin-top: 4px;
      margin-bottom: 6px;
    }
    .author img {
      width: 40px;
      height: 40px;
      border-radius: 5px;
      margin-right: 8px;
      object-fit: cover;
    }
    #commentsList {
      margin-top: 10px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body class="bg-animation">
  <a href="./"><img class="logo" src="logo.png" alt="logo" width="200" height="100" /></a>
  <p><button onclick="toggleTheme()" id="themeBtn">Light Mode</button></p>
  <table>
    <tr>
      <th><input type="button" value="share" onclick="copyUrl()" /></th>
      <th><input type="button" value="embed" onclick="copyCode()" /></th>
    </tr>
  </table>
  <div id="content"></div>
<script>
  const id = new URLSearchParams(location.search).get("id");
  const content = document.getElementById("content");

  if (!id) {
    content.innerHTML = `<p class="error">Pikko and Pikko Videos couldn't find this video or music.</p>`;
  } else {
    fetch(`${SERVER}/videoInfo/${id}`)
      .then(res => res.ok ? res.json() : null)
      .then(info => {
        if (!info || !info.fileName) {
          content.innerHTML = `<p class="error">Pikko and Pikko Videos couldn't find this video or music.</p>`;
          return;
        }

        document.title = `${info.title} - Pikko Videos`;
        const ext = info.fileName.split(".").pop().toLowerCase();
        const isAudio = ext === "mp3" || ext === "wav";
        const mediaUrl = `${SERVER}/videos/${info.fileName}`;
        const lockIcon = info.hasPassword ? `<img src="img/lock.svg" alt="locked" class="lockIcon">` : "";
        const postedTime = new Date(info.date).toLocaleString("ja-JP", {
          year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit"
        });

        if (info.hasPassword) {
          content.innerHTML = `
            <h1>${info.title} ${lockIcon}</h1>
            <div class="author">
              <img src="${SERVER}/icons/${info.username}.jpg" alt="icon">
              <a href="user?name=${encodeURIComponent(info.username)}">${info.username}</a>
            </div>
            <div style="font-size: 0.9em;">${postedTime}</div>
            <p>This video or music is locked. Please enter the password to watch.</p>
            <input type="password" id="passInput" placeholder="Password" style="padding: 6px;">
            <button onclick="checkAccess()">Unlock</button>
            <p id="errorMsg" class="error"></p>
          `;

          window.checkAccess = () => {
            const password = document.getElementById("passInput").value;
            fetch(`${SERVER}/checkAccess`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ id, password })
            })
              .then(res => res.ok ? res.json() : null)
              .then(result => {
                if (result?.access) {
                  showMedia(info, mediaUrl, isAudio, lockIcon, postedTime);
                } else {
                  document.getElementById("errorMsg").textContent = "Incorrect password.";
                }
              })
              .catch(() => {
                document.getElementById("errorMsg").textContent = "Failed to verify password.";
              });
          };
        } else {
          showMedia(info, mediaUrl, isAudio, lockIcon, postedTime);
        }

        function showMedia(info, mediaUrl, isAudio, lockIcon, postedTime) {
          const playerHtml = isAudio ? `
            <div id="waveform"></div>
            <div id="controls"><button id="togglePlay">play</button></div>
          ` : `
            <video id="player" width="480px" height="270px" controls controlsList="nodownload" autoplay playsinline></video>
          `;

          content.innerHTML = `
            <h1>${info.title} ${lockIcon}</h1>
            <div class="author">
              <img src="${SERVER}/icons/${info.username}.jpg" alt="icon">
              <a href="user?name=${encodeURIComponent(info.username)}">${info.username}</a>
            </div>
            <div style="font-size: 0.9em;">${postedTime}</div>
            ${playerHtml}
            <p style="white-space: pre-wrap; margin-top: 1em;">${rewriteDescription(info.description)}</p>
          `;

          if (isAudio) {
            const wavesurfer = WaveSurfer.create({
              container: '#waveform',
              waveColor: '#888',
              progressColor: '#0af',
              height: 100,
              responsive: true
            });

            wavesurfer.load(mediaUrl);

            const btn = document.getElementById("togglePlay");
            btn.addEventListener("click", () => {
              wavesurfer.playPause();
            });

            wavesurfer.on("play", () => {
              btn.textContent = "pause";
            });

            wavesurfer.on("pause", () => {
              btn.textContent = "play";
            });
          } else {
            fetch(mediaUrl)
              .then(res => res.blob())
              .then(blob => {
                const url = URL.createObjectURL(blob);
                document.getElementById("player").src = url;
              })
              .catch(() => {
                const player = document.getElementById("player");
                if (player) {
                  player.replaceWith(`<p class="error">Failed to load video file.</p>`);
                }
              });
          }

          // „Ç≥„É°„É≥„Éà„Çª„ÇØ„Ç∑„Éß„É≥ËøΩÂä†
          const commentSection = document.createElement("div");
          commentSection.innerHTML = `
            <h2 style="margin-top: 1em;">üí¨ „Ç≥„É°„É≥„Éà</h2>
            <div id="commentsList">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
            <textarea id="commentInput" placeholder="„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ..." rows="3" style="width:100%; margin-top:10px;"></textarea>
            <button onclick="submitComment()" style="margin-top:6px;">ÈÄÅ‰ø°</button>
            <p id="commentError" class="error"></p>
          `;
          content.appendChild(commentSection);

          function loadComments() {
            fetch(`${SERVER}/comments?id=${id}`)
              .then(res => res.json())
              .then(comments => {
                const list = document.getElementById("commentsList");
                list.innerHTML = "";
                if (comments.length === 0) {
                  list.textContent = "„Ç≥„É°„É≥„Éà„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ";
                  return;
                }
                comments.forEach(c => {
                  const div = document.createElement("div");
                  div.textContent = \`\${c.user}: \${c.text}\`;
                  list.appendChild(div);
                });
              })
              .catch(err => {
                document.getElementById("commentsList").textContent = "„Ç≥„É°„É≥„Éà„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ";
                console.error(err);
              });
          }

          function submitComment() {
            const input = document.getElementById("commentInput");
            const text = input.value.trim();
            if (!text) return;

            fetch(`${SERVER}/comments?id=${id}`, { 
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ text })
            })
              .then(res => {
                if (!res.ok) throw new Error("ÈÄÅ‰ø°Â§±Êïó");
                input.value = "";
                loadComments();
              })
              .catch(err => {
                document.getElementById("commentError").textContent = "„Ç≥„É°„É≥„Éà„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ";
                console.error(err);
              });
          }

          loadComments();
        }
      })
      .catch(() => {
        content.innerHTML = `<p class="error">error</p>`;
      });
  }

  function rewriteDescription(desc) {
    const temp = document.createElement("div");
    temp.innerHTML = desc;
    const urls = temp.querySelectorAll("url");
    urls.forEach(node => {
      const parts = node.textContent.split("|");
      const raw = parts[0]?.trim();
      const text = parts[1]?.trim() || raw;
      const encoded = encodeURIComponent(raw);
      const a = document.createElement("a");
      a.href = `redirect?url=${encoded}`;
      a.textContent = text;
      a.target = "_blank";
      a.rel = "noopener";
      node.replaceWith(a);
    });
    return temp.innerHTML;
  }

  function copyUrl() {
    navigator.clipboard.writeText(location.href);
  }

  function copyCode() {
    const url = `<iframe src="https://videos.bird.f5.si/embed?id=${id}" width="560" height="315" frameborder="0" allowfullscreen></iframe>`;
    navigator.clipboard.writeText(url);
  }
</script>
</body>
</html>

