<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>watch - Pikko Videos</title>
  <meta name="description" content="Let's watch the videos and musics.">
  <meta property="og:title" content="Pikko Videos">
  <meta property="og:description" content="Let's watch the videos.">
  <meta property="og:url" content="https://videos.bird.f5.si">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script>const SERVER = "https://pikko1.tcpexposer.com";</script>
  <script src="https://unpkg.com/wavesurfer.js"></script>
  <script src="js/dark.js"></script>
  <link rel="stylesheet" href="css/animation.css">
  <link rel="stylesheet" href="css/dark.css">
  <style>
    body { font-family: sans-serif; }
    .error { color: red; font-weight: bold; margin-top: 1em; }
    #waveform { width: 100%; height: 100px; background: #f0f0f0; margin-top: 20px; }
    #controls { margin-top: 10px; }
    button {
      background: #0af; color: white; border: none; padding: 8px 14px;
      font-size: 14px; cursor: pointer; border-radius: 4px;
    }
    button:hover { background: #09c; }
    .lockIcon { width: 16px; height: 16px; vertical-align: middle; margin-left: 4px; }
    .author {
      display: flex; align-items: center; margin-top: 4px; margin-bottom: 6px;
    }
    .author img {
      width: 40px; height: 40px; border-radius: 5px; margin-right: 8px; object-fit: cover;
    }
    #videoWrapper {
      position: relative;
      width: 100%;
      max-width: 960px;
      margin: 0 auto;
      aspect-ratio: 16 / 9;
    }
    #player {
      width: 100%;
      height: 100%;
      background: black;
    }
    /* 追加：暗転オーバーレイ */
    #videoOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.25);
      pointer-events: none;
      z-index: 5;
      display: none;
    }
    .subtitle {
      position: absolute;
      bottom: 5%;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 1.5em;
      color: white;
      background-color: rgba(0, 0, 0, 0.6);
      padding: 0.2em 0.6em;
      border-radius: 6px;
      pointer-events: none;
      z-index: 10;
      box-sizing: border-box;
      white-space: pre-wrap;
      display: none;
    }
    .custom-controls {
      position: absolute;
      bottom: 5%;
      left: 0;
      width: 100%;
      display: flex;
      gap: 8px;
      justify-content: center;
      align-items: center;
      z-index: 20;
    }
    .custom-controls button,
    .custom-controls select,
    .custom-controls input[type="range"] {
      font-size: 1em;
      padding: 0.4em 0.8em;
      border-radius: 4px;
      border: none;
      background: #0af;
      color: white;
      cursor: pointer;
    }
    .custom-controls button:hover {
      background: #09c;
    }
    #seekBar {
      width: 160px;
      height: 32px;
      cursor: pointer;
      appearance: none;
      background: #ccc;
      border-radius: 8px;
    }
    #seekBar::-webkit-slider-thumb {
      appearance: none;
      width: 24px;
      height: 24px;
      background: #0af;
      border-radius: 50%;
      border: none;
      margin-top: -6px;
    }
    #seekBar::-moz-range-thumb {
      width: 24px;
      height: 24px;
      background: #0af;
      border-radius: 50%;
      border: none;
    }
  </style>
</head>
<body class="bg-animation">
  <a href="./"><img class="logo" src="logo.png" alt="logo" width="200" height="100" /></a>
  <p><button onclick="toggleTheme()" id="themeBtn">Light Mode</button></p>
  <table>
    <tr>
      <th><input type="button" value="share" onclick="copyUrl()" /></th>
      <th><input type="button" value="embed" onclick="copyCode()" /></th>
    </tr>
  </table>
  <div id="content"></div>
<script>
const id = new URLSearchParams(location.search).get("id");
const content = document.getElementById("content");

function resizeSubtitleAndControls() {
  const subtitleDiv = document.getElementById("subtitle");
  const customControls = document.getElementById("customControls");
  if (document.fullscreenElement) {
    if (subtitleDiv) subtitleDiv.style.bottom = "8%";
    if (customControls) customControls.style.bottom = "3%";
  } else {
    if (subtitleDiv) subtitleDiv.style.bottom = "5%";
    if (customControls) customControls.style.bottom = "5%";
  }
}

document.addEventListener("fullscreenchange", resizeSubtitleAndControls);
window.addEventListener("resize", resizeSubtitleAndControls);
if (!id) {
  content.innerHTML = `<p class="error">Pikko and Pikko Videos couldn't find this video or music.</p>`;
} else {
  fetch(`${SERVER}/videoInfo/${id}`)
    .then(res => res.ok ? res.json() : null)
    .then(info => {
      if (!info || !info.fileName) {
        content.innerHTML = `<p class="error">Pikko and Pikko Videos couldn't find this video or music.</p>`;
        return;
      }

      document.title = `${info.title} - Pikko Videos`;
      const ext = info.fileName.split(".").pop().toLowerCase();
      const isAudio = ext === "mp3" || ext === "wav";
      const mediaUrl = `${SERVER}/videos/${info.fileName}`;
      const lockIcon = info.hasPassword ? `<img src="img/lock.svg" alt="locked" class="lockIcon">` : "";
      const postedTime = new Date(info.date).toLocaleString("ja-JP", {
        year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit"
      });

      if (info.hasPassword) {
        content.innerHTML = `
          <h1>${info.title} ${lockIcon}</h1>
          <div class="author">
            <img src="${SERVER}/icons/${info.username}.jpg" alt="icon">
            <a href="user?name=${encodeURIComponent(info.username)}">${info.username}</a>
          </div>
          <div style="font-size: 0.9em;">${postedTime}</div>
          <p>This video or music is locked. Please enter the password to watch.</p>
          <input type="password" id="passInput" placeholder="Password" style="padding: 6px;">
          <button onclick="checkAccess()">Unlock</button>
          <p id="errorMsg" class="error"></p>
        `;

        window.checkAccess = () => {
          const password = document.getElementById("passInput").value;
          fetch(`${SERVER}/checkAccess`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id, password })
          })
            .then(res => res.ok ? res.json() : null)
            .then(result => {
              if (result?.access) {
                showMedia(info, mediaUrl, isAudio, lockIcon, postedTime);
              } else {
                document.getElementById("errorMsg").textContent = "Incorrect password.";
              }
            })
            .catch(() => {
              document.getElementById("errorMsg").textContent = "Failed to verify password.";
            });
        };
      } else {
        showMedia(info, mediaUrl, isAudio, lockIcon, postedTime);
      }

      function showMedia(info, mediaUrl, isAudio, lockIcon, postedTime) {
        const playerHtml = isAudio ? `
          <div id="waveform"></div>
          <div id="controls"><button id="togglePlay">play</button></div>
        ` : `
          <div id="videoWrapper">
            <video id="player" autoplay playsinline></video>
            <div id="videoOverlay"></div>
            <div class="subtitle" id="subtitle"></div>
            <div class="custom-controls" id="customControls">
              <button id="playPauseBtn" aria-label="Play/Pause"></button>
              <button id="fullscreenBtn" aria-label="Fullscreen">⛶</button>
              <button id="toggleSubtitle">sub off</button>
              <select id="subtitleLang"></select>
              <input type="range" id="seekBar" min="0" max="100" value="0" step="0.1" />
              <span id="timeDisplay" style="min-width: 90px; text-align: right; color: white;"></span>
            </div>
          </div>
        `;

        content.innerHTML = `
          <h1>${info.title} ${lockIcon}</h1>
          <div class="author">
            <img src="${SERVER}/icons/${info.username}.jpg" alt="icon">
            <a href="user?name=${encodeURIComponent(info.username)}">${info.username}</a>
          </div>
          <div style="font-size: 0.9em;">${postedTime}</div>
          ${playerHtml}
          <p style="white-space: pre-wrap; margin-top: 1em;">${rewriteDescription(info.description)}</p>
        `;

        if (isAudio) {
          const wavesurfer = WaveSurfer.create({
            container: '#waveform',
            waveColor: '#888',
            progressColor: '#0af',
            height: 100,
            responsive: true
          });

          wavesurfer.load(mediaUrl);

          const btn = document.getElementById("togglePlay");
          btn.addEventListener("click", () => {
            wavesurfer.playPause();
          });

          wavesurfer.on("play", () => {
            btn.textContent = "pause";
          });

          wavesurfer.on("pause", () => {
            btn.textContent = "play";
          });
        } else {
          fetch(mediaUrl)
            .then(res => res.blob())
            .then(blob => {
              const url = URL.createObjectURL(blob);
              const video = document.getElementById("player");
              video.src = url;

              const playPauseBtn = document.getElementById("playPauseBtn");
              const fullscreenBtn = document.getElementById("fullscreenBtn");
              const subtitleDiv = document.getElementById("subtitle");
              const toggleBtn = document.getElementById("toggleSubtitle");
              const langSelect = document.getElementById("subtitleLang");
              const seekBar = document.getElementById("seekBar");
              const timeDisplay = document.getElementById("timeDisplay");
              const videoWrapper = document.getElementById("videoWrapper");
              const customControls = document.getElementById("customControls");
              const videoOverlay = document.getElementById("videoOverlay");

              const svgPlay = '<svg width="18" height="18" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg"><path d="M8 5v14l11-7z"/></svg>';
              const svgPause = '<svg width="18" height="18" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg>';

              function setPlayIcon() { playPauseBtn.innerHTML = svgPlay; }
              function setPauseIcon() { playPauseBtn.innerHTML = svgPause; }
              function formatTime(sec) {
                if (!isFinite(sec)) return "0:00";
                sec = Math.max(0, Math.floor(sec));
                const h = Math.floor(sec / 3600);
                const m = Math.floor((sec % 3600) / 60);
                const s = sec % 60;
                if (h > 0) {
                  return `${h}:${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
                }
                return `${m}:${String(s).padStart(2, "0")}`;
              }
              function updateTimeDisplay() {
                timeDisplay.textContent = `${formatTime(video.currentTime || 0)} / ${formatTime(video.duration || 0)}`;
              }
              function updatePlayPauseVisual() {
                if (video.ended || video.paused) {
                  setPlayIcon();
                } else {
                  setPauseIcon();
                }
              }

              playPauseBtn.addEventListener("click", () => {
                if (video.paused || video.ended) {
                  video.play();
                } else {
                  video.pause();
                }
              });

              fullscreenBtn.addEventListener("click", () => {
                if (document.fullscreenElement) {
                  document.exitFullscreen();
                } else {
                  videoWrapper.requestFullscreen();
                }
              });

              let subtitles = [];
              let subtitleEnabled = true;
              let controlsVisible = true;

              toggleBtn.addEventListener("click", () => {
                subtitleEnabled = !subtitleEnabled;
                toggleBtn.textContent = subtitleEnabled ? "sub off" : "sub on";
                subtitleDiv.textContent = "";
                subtitleDiv.style.display = "none";
              });

              video.addEventListener("loadedmetadata", () => {
                updateTimeDisplay();
                updatePlayPauseVisual();
              });

              video.addEventListener("play", () => { setPauseIcon(); });
              video.addEventListener("pause", () => { if (!video.ended) setPlayIcon(); });
              video.addEventListener("ended", () => { setPlayIcon(); updateTimeDisplay(); });

              video.addEventListener("timeupdate", () => {
                if (subtitleEnabled && subtitles.length > 0) {
                  const active = subtitles.find(s => video.currentTime >= s.start && video.currentTime <= s.end);
                  if (active) {
                    subtitleDiv.textContent = active.text;
                    subtitleDiv.style.display = "block";
                  } else {
                    subtitleDiv.textContent = "";
                    subtitleDiv.style.display = "none";
                  }
                } else {
                  subtitleDiv.textContent = "";
                  subtitleDiv.style.display = "none";
                }
                if (!isNaN(video.duration) && video.duration > 0) {
                  seekBar.value = (video.currentTime / video.duration) * 100;
                }
                updateTimeDisplay();
              });

              seekBar.addEventListener("input", () => {
                if (!isNaN(video.duration) && video.duration > 0) {
                  video.currentTime = (seekBar.value / 100) * video.duration;
                }
              });

              videoWrapper.addEventListener("click", (event) => {
                if (event.target === video) {
                  controlsVisible = !controlsVisible;
                  customControls.style.display = controlsVisible ? "flex" : "none";
                  videoOverlay.style.display = controlsVisible ? "block" : "none";
                }
              });

              function loadSubtitle(lang) {
                const sub = info.subtitles.find(s => s.language === lang);
                if (!sub) return;
                const langOnly = sub.fileName.replace(".vtt", "");
                fetch(`${SERVER}/subtitles/${id}/${langOnly}`)
                  .then(res => res.ok ? res.text() : "")
                  .then(text => { subtitles = parseVTT(text); });
              }

              function parseVTT(vttText) {
                vttText = vttText.replace(/\r\n/g, "\n").trim();
                const entries = [];
                const blocks = vttText.split(/\n\n+/);
                for (const block of blocks) {
                  const lines = block.trim().split("\n");
                  if (lines.length < 2) continue;
                  const timeLine = lines.find(line => line.includes("-->"));
                  if (!timeLine) continue;
                  const [start, end] = timeLine.split(" --> ").map(parseTime);
                  const text = lines.slice(lines.indexOf(timeLine) + 1).join("\n");
                  if (!isNaN(start) && !isNaN(end)) {
                    entries.push({ start, end, text });
                  }
                }
                return entries;
              }

              function parseTime(t) {
                const parts = t.split(":");
                if (parts.length === 3) {
                  return parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseFloat(parts[2]);
                } else if (parts.length === 2) {
                  const m = parseInt(parts[0]);
                  const s = parseFloat(parts[1]);
                  return m * 60 + s;
                } else {
                  return parseFloat(t);
                }
              }

              if (Array.isArray(info.subtitles) && info.subtitles.length > 0) {
                info.subtitles.forEach((sub, i) => {
                  const opt = document.createElement("option");
                  opt.value = sub.language;
                  opt.textContent = sub.language;
                  langSelect.appendChild(opt);
                  if (i === 0) langSelect.value = sub.language;
                });

                loadSubtitle(langSelect.value);

                langSelect.addEventListener("change", () => {
                  loadSubtitle(langSelect.value);
                });
              } else {
                subtitleEnabled = false;
                toggleBtn.disabled = true;
                subtitleDiv.style.display = "none";
              }

              updatePlayPauseVisual();
              updateTimeDisplay();
            })
            .catch(() => {
              const player = document.getElementById("player");
              if (player) {
                player.replaceWith(`<p class="error">Failed to load video file.</p>`);
              }
            });
        }
      }
    })
    .catch(() => {
      content.innerHTML = `<p class="error">error</p>`;
    });
}

function rewriteDescription(desc) {
  const temp = document.createElement("div");
  temp.innerHTML = desc;
  const urls = temp.querySelectorAll("url");
  urls.forEach(node => {
    const parts = node.textContent.split("|");
    const raw = parts[0]?.trim();
    const text = parts[1]?.trim() || raw;
    const encoded = encodeURIComponent(raw);
    const a = document.createElement("a");
    a.href = `redirect?url=${encoded}`;
    a.textContent = text;
    a.target = "_blank";
    a.rel = "noopener";
    node.replaceWith(a);
  });
  return temp.innerHTML;
}

function copyUrl() {
  navigator.clipboard.writeText(location.href);
}

function copyCode() {
  const url = `<iframe src="https://videos.bird.f5.si/embed?id=${id}" width="560" height="315" frameborder="0" allowfullscreen></iframe>`;
  navigator.clipboard.writeText(url);
}
</script>
</body>
</html>
