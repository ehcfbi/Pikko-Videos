<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>my page - Pikko Videos</title>
  <meta name="description" content="my page">
  <meta property="og:title" content="Pikko Videos">
  <meta property="og:description" content="my page">
  <meta property="og:url" content="https://videos.bird.f5.si">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="js/config.js"></script>
  <script src="js/storage.js"></script>
  <script src="js/dark.js"></script>
  <link rel="stylesheet" href="css/animation.css">
  <link rel="stylesheet" href="css/dark.css">
  <style>
    .lockIcon {
      width: 16px;
      height: 16px;
      vertical-align: middle;
      margin-left: 4px;
    }
    .upload_button {
      background: lightgreen;
      color: blue;
      border: none;
      padding: 8px 14px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 4px;
    }
    .upload_button:hover {
      background: #09c;
    }
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #ccc;
      border-top: 2px solid blue;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 6px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    #uploadStatus, #iconStatus {
      font-size: 14px;
      color: #333;
      margin-top: 8px;
    }
  </style>
</head>
<body class="bg-animation">
  <a href="./"><img class="logo" src="https://videos.bird.f5.si/logo.png" alt="logo" width="200" height="100"></a>
  <p><button onclick="toggleTheme()" id="themeBtn">Light Mode</button></p>
  <p><input type="button" value="share" onclick="copyUrl()"></p>

  <h1>My page</h1>
  <div style="display: flex; align-items: center;">
    <img id="iconPreview" src="" alt="icon" width="60" height="60" style="margin-right: 10px; object-fit: cover; border-radius: 5px;">
    <font size="7" color="purple"><p id="currentUser"></p></font>
  </div>

  <button onclick="logout()">logout</button>
  <button onclick="removeAccount()">delete this account</button>

  <h2>change account</h2>
  <input id="currentPassword" type="password" placeholder="current password"><br>
  <input id="newUsername" placeholder="new username"><br>
  <input id="newPassword" type="password" placeholder="new password"><br>
  <button onclick="changeAccount()">change account</button>

  <h2>change your icon</h2>
  <h3>icon(.jpg, 600px√ó600px, 30KB or less)</h3>
  <input id="iconInput" type="file" accept=".jpg"><br>
  <button onclick="updateIcon()">update icon</button>
  <div id="iconStatus"></div>

  <h2>upload a video or music</h2>
  <h3>title</h3>
  <input id="titleInput" placeholder="title"><br>
  <h3>video or music (.mp4 / .mp3 / .wav, 30MB or less)</h3>
  <input id="fileInput" type="file" accept="video/mp4,audio/mp3,audio/wav"><br>
  <h3>thumbnail (.jpg, 640√ó360 / 640√ó480 / 360√ó640, 50KB or less)</h3>
  <input type="checkbox" id="useThumbUpload"> upload custom thumbnail?<br>
  <input id="thumbInput" type="file" accept=".jpg" disabled><br>
  <label for="thumbSize">Thumbnail size:</label>
  <select id="thumbSize" disabled>
    <option value="640x360">640√ó360</option>
    <option value="640x480">640√ó480</option>
    <option value="360x640">360√ó640</option>
  </select><br>
  <h3>description</h3>
  <textarea id="description" placeholder="description" rows="4" cols="40"></textarea><br>
  <h3>lock</h3>
  <input type="checkbox" id="lockToggle" onchange="toggleUploadLock()"> lock this video or music<br>
  <input id="lockPassword" type="password" placeholder="password (if locked)" disabled><br>

  <!-- üîΩ Â≠óÂπï„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊ©üËÉΩ -->
  <h3>subtitle (.vtt, any language)</h3>
  <input type="checkbox" id="useSubtitleUpload"> upload custom subtitles?<br>
  <div id="subtitleUploadArea" style="display: none;">
    <input type="text" id="subtitleLangInput" placeholder="language (e.g. Êó•Êú¨Ë™û, english)"><br>
    <input type="file" id="subtitleInput" accept=".vtt"><br>
    <button onclick="addSubtitle()">add subtitle</button>
    <ul id="subtitleList"></ul>
  </div>

  <button class="upload_button" onclick="upload()">upload</button>
  <div id="uploadStatus"></div>

  <h2>your videos and musics</h2>
  <label for="sortSelect">Sort by:</label>
  <select id="sortSelect" onchange="setSortOrder(this.value)">
    <option value="desc">newest first</option>
    <option value="asc">oldest first</option>
  </select>
  <div id="list"></div>
<script>
  let subtitles = [];

  document.getElementById('useThumbUpload').addEventListener('change', function () {
    const enabled = this.checked;
    document.getElementById('thumbInput').disabled = !enabled;
    document.getElementById('thumbSize').disabled = !enabled;
  });

  document.getElementById('useSubtitleUpload').addEventListener('change', function () {
    document.getElementById('subtitleUploadArea').style.display = this.checked ? 'block' : 'none';
  });

  function addSubtitle() {
    const lang = document.getElementById('subtitleLangInput').value.trim();
    const fileInput = document.getElementById('subtitleInput');
    const file = fileInput.files[0];

    if (!lang || !file) {
      alert("Please provide both language and subtitle file.");
      return;
    }

    const reader = new FileReader();
    reader.onload = function (e) {
      const content = e.target.result;
      subtitles.push({ lang, content });
      updateSubtitleList();
      fileInput.value = '';
      document.getElementById('subtitleLangInput').value = '';
    };
    reader.readAsText(file);
  }

  function updateSubtitleList() {
    const list = document.getElementById('subtitleList');
    list.innerHTML = '';
    subtitles.forEach((sub, index) => {
      const li = document.createElement('li');
      li.textContent = `${sub.lang} subtitle added`;
      const delBtn = document.createElement('button');
      delBtn.textContent = 'remove';
      delBtn.onclick = () => {
        subtitles.splice(index, 1);
        updateSubtitleList();
      };
      li.appendChild(delBtn);
      list.appendChild(li);
    });
  }

  function toggleUploadLock() {
    const isLocked = document.getElementById('lockToggle').checked;
    document.getElementById('lockPassword').disabled = !isLocked;
  }

  async function upload() {
    const title = document.getElementById('titleInput').value.trim();
    const file = document.getElementById('fileInput').files[0];
    const thumbFile = document.getElementById('thumbInput').files[0];
    const description = document.getElementById('description').value.trim();
    const isLocked = document.getElementById('lockToggle').checked;
    const lockPassword = document.getElementById('lockPassword').value;
    const thumbSize = document.getElementById('thumbSize').value;

    if (!title || !file) {
      alert("Title and media file are required.");
      return;
    }

    const formData = new FormData();
    formData.append('title', title);
    formData.append('file', file);
    formData.append('description', description);
    formData.append('locked', isLocked);
    if (isLocked) formData.append('lockPassword', lockPassword);
    if (thumbFile) {
      formData.append('thumb', thumbFile);
      formData.append('thumbSize', thumbSize);
    }

    // Â≠óÂπï„ÇíËøΩÂä†
    subtitles.forEach((sub, i) => {
      formData.append(`subtitleLang${i}`, sub.lang);
      formData.append(`subtitleContent${i}`, sub.content);
    });

    document.getElementById('uploadStatus').innerHTML = '<span class="spinner"></span>Uploading...';

    try {
      const res = await fetch('/api/upload', {
        method: 'POST',
        body: formData
      });
      const result = await res.json();
      if (result.success) {
        document.getElementById('uploadStatus').textContent = 'Upload successful!';
        subtitles = [];
        updateSubtitleList();
      } else {
        document.getElementById('uploadStatus').textContent = 'Upload failed: ' + result.message;
      }
    } catch (err) {
      document.getElementById('uploadStatus').textContent = 'Upload error: ' + err.message;
    }
  }

  // ‰ªñ„ÅÆÊó¢Â≠òÈñ¢Êï∞Ôºàlogout, changeAccount, updateIcon, removeAccount „Å™„Å©Ôºâ„ÅØ Part 3 „Å´Á∂ö„Åç„Åæ„Åô
  async function logout() {
    await fetch('/api/logout', { method: 'POST' });
    location.href = './';
  }

  async function removeAccount() {
    if (!confirm("Are you sure you want to delete this account?")) return;
    await fetch('/api/removeAccount', { method: 'POST' });
    location.href = './';
  }

  async function changeAccount() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newUsername = document.getElementById('newUsername').value;
    const newPassword = document.getElementById('newPassword').value;

    const res = await fetch('/api/changeAccount', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ currentPassword, newUsername, newPassword })
    });
    const result = await res.json();
    alert(result.message);
    if (result.success) location.reload();
  }

  async function updateIcon() {
    const iconFile = document.getElementById('iconInput').files[0];
    if (!iconFile) {
      alert("Please select an icon file.");
      return;
    }

    const formData = new FormData();
    formData.append('icon', iconFile);

    document.getElementById('iconStatus').innerHTML = '<span class="spinner"></span>Uploading...';

    try {
      const res = await fetch('/api/updateIcon', {
        method: 'POST',
        body: formData
      });
      const result = await res.json();
      if (result.success) {
        document.getElementById('iconStatus').textContent = 'Icon updated!';
        document.getElementById('iconPreview').src = result.iconUrl;
      } else {
        document.getElementById('iconStatus').textContent = 'Update failed: ' + result.message;
      }
    } catch (err) {
      document.getElementById('iconStatus').textContent = 'Error: ' + err.message;
    }
  }

  async function copyUrl() {
    try {
      await navigator.clipboard.writeText(location.href);
      alert("URL copied to clipboard!");
    } catch (err) {
      alert("Failed to copy URL.");
    }
  }

  async function setSortOrder(order) {
    localStorage.setItem('sortOrder', order);
    await loadList();
  }

  async function loadList() {
    const res = await fetch('/api/myList');
    const result = await res.json();
    const listDiv = document.getElementById('list');
    listDiv.innerHTML = '';

    const sortOrder = localStorage.getItem('sortOrder') || 'desc';
    const items = sortOrder === 'asc' ? result.items : result.items.reverse();

    items.forEach(item => {
      const div = document.createElement('div');
      div.innerHTML = `
        <h3>${item.title}</h3>
        <img src="${item.thumb}" width="160"><br>
        <a href="watch.html?id=${item.id}">watch</a>
      `;
      listDiv.appendChild(div);
    });
  }

  async function loadUser() {
    const res = await fetch('/api/currentUser');
    const result = await res.json();
    document.getElementById('currentUser').textContent = result.username;
    document.getElementById('iconPreview').src = result.iconUrl;
  }

  loadUser();
  loadList();
</script>
</body>
</html>
